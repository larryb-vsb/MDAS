#!/usr/bin/env node

// Test script to verify all TDDF record types process successfully
import { Pool } from '@neondatabase/serverless';
import fs from 'fs';
import { createRequire } from 'module';
const require = createRequire(import.meta.url);

const pool = new Pool({ connectionString: process.env.DATABASE_URL });

async function testAllRecordTypes() {
  const client = await pool.connect();
  
  try {
    console.log('=============== ALL RECORD TYPES PROCESSING TEST ===============');
    console.log('Testing that all implemented record types process successfully');
    
    // Test file with one of each record type
    const testFileId = `test_all_types_${Date.now()}`;
    const testTddfContent = `01602850573090001BH6759067590000000174800001800000901710262022299220000000000000000    0000090001020001N8000016759C10272022
01602860573090002DT67590675900000000174800001800000010180000124001192299900010200001102620220000000000129922000000000000596408699XXXXXX0000       VS04VS111111111   NYV1 A E462299780188823N840000000000000M7NG00    05DNVERMONT STATE BANK       59470D    VS84000000000000 N  549975551542                            000000000+                D CD 12057                     000000000  N000000000 452   0000000000000.00 0000000.00   0000000.00                             000000000000000                                                                                                                                                     01418 F000000000000 0000000000000.25     02200 00000                  
01602870573090003P167590675900000000174800001800000010180000124001102620220000001299000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01602880573090004P267590675900000000174800001800000010180000000000000+0000012990000000000ABCD1234567890  3234567890123456789012345678901234567    00012340000001234000000000N99990000000000000000000000C5000000000000000+TRAVEL EXPENSE ITEM           0000000000120000000000120000000000000+N000009999000000000000000000+C00000000000001234000000000+SERVICE CHARGE ITEM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
01602890573090005E167590675900000000174800001800000010180000134001102620220000001299011234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890
01602900573090006GE6759067590000000017480000180000001018000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01602910573090007G26759067590000000017480000180000001018000013400110262022000000129900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01602920573090008AD6759067590000000017480000180000001018000013400110262022000000129900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01602930573090009DR6759067590000000017480000180000001018000013400110262022000000129900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01602940573090010CK6759067590000000017480000180000001018000999888777666555999888777666555123456789012345PPP555666777888123456789012345123456789012JANE DOE          P  HOTEL CITY  NY  00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01602950573090011LG67590675900000000174800001800000010180009876543210        9876543210123N012345012345LODGING CORP    0000012990000001299000000129900000012990000001299000000012990000000000000000129900000012990000001299000000012990000001299000000129900000012990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`;
    
    // Write test file
    fs.writeFileSync(`test_all_types_${testFileId}.TSYSO`, testTddfContent);
    
    console.log('\n1. Uploading test file with all record types...');
    
    await client.query(`
      INSERT INTO dev_uploaded_files (id, original_filename, file_type, status, file_size, upload_date, content)
      VALUES ($1, $2, 'tddf', 'uploaded', $3, NOW(), $4)
    `, [testFileId, `test_all_types_${testFileId}.TSYSO`, testTddfContent.length, testTddfContent]);
    
    // Process raw data 
    const lines = testTddfContent.split('\n').filter(line => line.trim());
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const recordType = line.substring(17, 19);
      
      await client.query(`
        INSERT INTO dev_tddf_raw_import (source_file_id, line_number, raw_line, record_type, processing_status, created_at)
        VALUES ($1, $2, $3, $4, 'pending', NOW())
      `, [testFileId, i + 1, line, recordType]);
    }
    
    console.log(`   ✓ Uploaded ${lines.length} lines with record types:`);
    const recordTypeCounts = {};
    lines.forEach(line => {
      const recordType = line.substring(17, 19);
      recordTypeCounts[recordType] = (recordTypeCounts[recordType] || 0) + 1;
    });
    
    for (const [type, count] of Object.entries(recordTypeCounts)) {
      console.log(`      ${type}: ${count} records`);
    }
    
    // Run switch-based processing
    console.log('\n2. Running switch-based processing for all record types...');
    
    const { DatabaseStorage } = require('./server/storage.ts');
    const storage = new DatabaseStorage();
    
    const startTime = Date.now();
    const result = await storage.processPendingTddfRecordsSwitchBased(testFileId, 20);
    const processingTime = Date.now() - startTime;
    
    console.log(`   ✓ Processing completed in ${processingTime}ms`);
    console.log(`   ✓ Results: ${result.totalProcessed} processed, ${result.totalSkipped} skipped, ${result.totalErrors} errors`);
    
    if (result.breakdown) {
      console.log('\n3. Processing breakdown by record type:');
      for (const [recordType, stats] of Object.entries(result.breakdown)) {
        const status = stats.processed > 0 ? '✅' : stats.errors > 0 ? '❌' : '⚠️';
        console.log(`   ${status} ${recordType}: ${stats.processed} processed, ${stats.skipped} skipped, ${stats.errors} errors`);
      }
    }
    
    // Verify zero pending records
    const finalPending = await client.query(`
      SELECT COUNT(*) as count FROM dev_tddf_raw_import 
      WHERE source_file_id = $1 AND processing_status = 'pending'
    `, [testFileId]);
    
    console.log(`\n4. Final verification:`);
    console.log(`   ✓ Pending records remaining: ${finalPending.rows[0].count}`);
    
    // Check any errors
    const errorCheck = await client.query(`
      SELECT record_type, skip_reason, COUNT(*) as count 
      FROM dev_tddf_raw_import 
      WHERE source_file_id = $1 AND processing_status = 'skipped' AND skip_reason NOT LIKE '%duplicate%'
      GROUP BY record_type, skip_reason
    `, [testFileId]);
    
    if (errorCheck.rows.length > 0) {
      console.log('\n⚠️  Processing Issues Found:');
      for (const row of errorCheck.rows) {
        console.log(`   ${row.record_type}: ${row.skip_reason} (${row.count} records)`);
      }
    }
    
    const success = finalPending.rows[0].count === 0 && result.totalErrors === 0;
    console.log(`\n5. TEST RESULT: ${success ? '✅ SUCCESS' : '❌ FAILED'}`);
    
    if (success) {
      console.log('   ✓ All record types processed successfully');
      console.log('   ✓ No pending records remain');
      console.log('   ✓ Switch processing works for all implemented record types');
    } else {
      console.log(`   ❌ ${finalPending.rows[0].count} records still pending or ${result.totalErrors} errors occurred`);
      console.log('   ❌ Some record types need implementation fixes');
    }
    
    // Cleanup
    await client.query(`DELETE FROM dev_tddf_raw_import WHERE source_file_id = $1`, [testFileId]);
    await client.query(`DELETE FROM dev_uploaded_files WHERE id = $1`, [testFileId]);
    fs.unlinkSync(`test_all_types_${testFileId}.TSYSO`);
    
    console.log('\n6. Test cleanup completed');
    
  } catch (error) {
    console.error('Error during all record types test:', error);
  } finally {
    client.release();
  }
}

testAllRecordTypes();