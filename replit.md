# Merchant Management System (MMS) - Architecture Guide

## Overview

The Merchant Management System (MMS) is a comprehensive web application designed to help businesses manage merchant relationships, process transactions, and analyze business data. The system provides features for merchant management, transaction processing, file uploads, data analytics, and automated backup management.

## User Preferences

Preferred communication style: Simple, everyday language.

## Recent Changes

### Smart Duplicate Transaction Handling with Date Matching (July 17, 2025)
- **ENHANCED LOGIC**: Modified upload logic to check transaction dates when duplicates are found
- **DATE MATCHING**: If Transaction ID and date match exactly, system compares values and either updates or skips
- **VALUE COMPARISON**: When dates match, compares amounts and transaction types for differences
- **UPDATE LOGIC**: Automatically updates existing transactions if values differ (amount or type)
- **SKIP LOGIC**: Skips duplicate transactions with identical date, amount, and type to avoid redundancy
- **FALLBACK**: Still creates incremented IDs (e.g., .1, .2) only when dates differ but Transaction ID is same
- **SMART HANDLING**: Prevents unnecessary duplicate creation while allowing legitimate same-ID different-date transactions
- **COMPREHENSIVE LOGGING**: Enhanced logging shows date matches, updates, skips, and incrementation decisions

### Transaction ID Quick Filter Implementation (July 17, 2025)
- **COMPLETED**: Added Transaction ID quick filter to Transactions page for improved search capabilities
- **FRONTEND**: Updated filter layout to 4-column grid with new Transaction ID input field
- **BACKEND**: Enhanced API endpoints (/api/transactions and /api/transactions/export) to support transactionId parameter
- **DATABASE**: Updated storage interface and implementations with case-insensitive partial matching using ILIKE
- **REAL-TIME SEARCH**: Filter works as you type with instant results and proper pagination
- **EXPORT INTEGRATION**: Transaction ID filter included in CSV export functionality
- **FALLBACK SUPPORT**: Updated both database and in-memory storage implementations
- **CONFIRMED WORKING**: Successfully filters transactions including auto-incremented duplicate IDs (e.g., "71127230000358.2")
- Supports partial Transaction ID searches for easy lookup and verification

### Merchant Name Matching Algorithm Optimization (July 17, 2025)
- **RESOLVED**: Fixed false fuzzy matching that incorrectly matched unrelated businesses based on business suffixes
- **ISSUE**: "SOODAKS INC" was incorrectly matching to "Alternate Health Collective Association Inc" just because both contained "inc"
- **SOLUTION**: Completely disabled aggressive fuzzy matching that matched on business entity types (LLC, INC, etc.)
- **NEW LOGIC**: Only allows exact core business name matches after removing business suffixes
- **RESULT**: New merchants with unique names now properly create with "Pending" status instead of false matches
- **CONFIRMED WORKING**: SOODAKS INC merchant successfully created with ID 43132391 and "Pending" status
- Prevents false associations between completely different businesses
- Maintains exact name matching and core business name matching (e.g., "McDonald's LLC" matches "McDonald's Inc")

### Auto-Increment Duplicate Transaction ID Resolution (July 17, 2025)
- Implemented automatic duplicate Transaction ID resolution by incrementing by 0.1
- System now automatically handles duplicate Transaction IDs during CSV processing
- For numeric IDs: increments by 0.1 (e.g., 123456 becomes 123456.1, 123456.2, etc.)
- For non-numeric IDs: appends suffix (e.g., ABC123 becomes ABC123_1, ABC123_2, etc.)
- Enhanced error reporting shows when duplicates are detected and resolved
- Prevents processing failures due to duplicate Transaction IDs from previous uploads
- Allows all transaction records to be inserted successfully without manual intervention
- Added comprehensive logging to track duplicate resolution attempts and final IDs
- Updated auto-created merchant status to "Pending" for all new merchants created during transaction imports

### ZIP Export Functionality Implementation (July 15, 2025)
- Implemented true ZIP file export for "Export All (ZIP)" functionality
- Added archiver library for proper ZIP file creation with compression
- Updated export process to create three separate CSV files (merchants, transactions, batch summary)
- Each CSV file is properly named and packaged in a downloadable ZIP file
- Fixed frontend date parameter handling for all-data export type
- Updated backend to serve proper ZIP files with correct MIME type (application/zip)
- ZIP files contain separate CSV files for integration with external systems
- Automatic cleanup of temporary files after ZIP creation
- Fixed ZIP content issue to include actual CSV data instead of file paths
- Enhanced export history with proper date sorting (newest first) and realistic file sizes
- Improved export history display with correct file extensions (.zip for all-data exports)
- Set "Export All (ZIP)" as the default export option for streamlined external system integration

### Analytics Page Enhancement (July 16, 2025)
- Fixed analytics to show only real transaction data instead of synthetic future data
- Removed artificial 2025 data generation that was creating confusion
- Analytics now groups actual transactions by month and year from database
- Displays authentic data from January-June 2024 with accurate transaction counts and revenue
- Intelligent year display: shows current year and previous year when data is available
- Future-ready: will automatically show year-over-year comparisons as more data accumulates
- Complete 12-month structure for proper comparison when multiple years of data exist

### Transaction Filters Enhancement (July 15, 2025)
- Simplified date inputs to text-only fields based on user preference  
- Implemented validation on blur/exit instead of during typing to prevent search triggers
- Added support for multiple date formats: YYYY-MM-DD, MM/DD/YYYY, MM-DD-YYYY
- Auto-corrects date format to YYYY-MM-DD when user finishes typing
- Enhanced error handling to gracefully reset invalid dates to previous valid values
- Enhanced quick filter buttons (Today, This Week, This Month, 2024 All Data) for common date ranges
- Modified year filter to show 2024 data since all transactions are from that year (Jan-Jun 2024)
- Eliminated complex calendar/text input combinations for cleaner user experience

### Enhanced Merchant Export Functionality (July 15, 2025)
- Updated merchant export format to match business requirements with proper field mapping
- Added new "All Merchants for Date" export option for AsOfDate-based merchant exports
- Fields now include: AsOfDate, ClientNum, ClientLega, ClientMID, ClientPAd fields, ClientSinc, location data, MType, SalesChannel
- Added API endpoint: /api/exports/merchants-all/download with targetDate parameter
- Updated UI to support single date selection for merchants-all export type
- Verified both regular merchant export and all-merchants-for-date export working correctly
- Export format matches provided specification with proper date formatting (M/D/YYYY)

### Batch Summary Export Implementation (July 15, 2025)
- Fixed batch summary export SQL syntax issues and variable references
- Corrected date handling to use proper date range comparisons instead of timezone-dependent logic
- Export now works with real transaction data grouping by ClientMID for specific dates
- Fields include: ClientMid, AsOfDate, BatchNum, TranCoun, DailyTotal, FeeTotal, FeesWithh
- Added API endpoint: /api/exports/batch-summary/download
- UI shows single date picker for batch summary vs date range for other exports
- Verified functionality working correctly with real transaction data
- User confirmed batch summary export produces expected results

### Export Functionality Enhancement (July 15, 2025)
- Fixed export button to use current screen filter values for transactions
- Corrected date filtering logic in backend export function to properly combine filter conditions
- Fixed CSV generation to properly create export files using manual CSV formatting
- Export now properly applies merchant, date range, and transaction type filters
- Verified export works correctly with all filter combinations
- User confirmed export functionality is working properly

### Search Functionality Enhancement (July 15, 2025)
- Fixed case-sensitive search issue by implementing ilike instead of like in PostgreSQL queries
- Added missing searchQuery state management to Dashboard component
- Connected search functionality to work from both home screen and merchants page
- Search now supports case-insensitive partial matching for merchant names, IDs, and MIDs
- Created comprehensive unit tests for search functionality
- User confirmed search functionality is working properly

## System Architecture

MMS follows a modern client-server architecture with clear separation between frontend and backend components:

### High-Level Architecture
```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│                 │      │                 │      │                 │
│  React Frontend │<─────│  Express.js API │<─────│  PostgreSQL DB  │
│                 │      │                 │      │                 │
└─────────────────┘      └─────────────────┘      └─────────────────┘
```

The architecture is designed for scalability and maintainability with:
- **Frontend**: React-based SPA with TypeScript and modern UI components
- **Backend**: RESTful Express.js API with comprehensive business logic
- **Database**: PostgreSQL with Drizzle ORM for type-safe database operations
- **State Management**: React Query for efficient server state management

## Key Components

### Frontend Architecture
- **Component Structure**: Organized into pages, reusable components, and UI primitives
- **Styling**: TailwindCSS with shadcn/ui component system based on Radix UI
- **Routing**: Wouter for lightweight client-side routing
- **State Management**: React Query for server state, React hooks for local state
- **Authentication**: Context-based auth system with protected routes
- **Forms**: React Hook Form with Zod validation

### Backend Architecture
- **API Layer**: Express.js with TypeScript for type safety
- **Database Layer**: Drizzle ORM with PostgreSQL for schema management
- **File Processing**: Multer for file uploads with CSV parsing capabilities
- **Authentication**: Passport.js with local strategy and bcrypt password hashing
- **Storage Interface**: Abstracted storage layer supporting database and in-memory fallback
- **Backup System**: Automated backup scheduling with local and S3 storage options

### Database Schema
- **Merchants**: Core entity with comprehensive profile information
- **Transactions**: Financial transaction records linked to merchants
- **Users**: Authentication and authorization management
- **Uploaded Files**: File upload tracking and processing status
- **Backup Management**: Automated backup history and scheduling
- **Audit Logging**: System, security, and audit log tracking
- **Schema Versioning**: Database migration and version tracking

## Data Flow

### User Interaction Flow
1. User authenticates through login page
2. Protected routes verify authentication status
3. Dashboard displays key metrics and recent activity
4. Users can navigate to specific features (merchants, transactions, uploads)
5. All data changes trigger audit logging

### File Processing Flow
1. User uploads CSV files through upload interface
2. Files are validated and stored with metadata
3. Background processing parses CSV data
4. Data is mapped to database schema using field mappings
5. Processing results are logged and displayed to user

### Backup Flow
1. Scheduled backups run automatically based on configured schedules
2. Backup data is created with complete database snapshot
3. Backups can be stored locally or uploaded to S3
4. Backup history is maintained with retention policies
5. Manual backup creation and restoration capabilities

## External Dependencies

### Core Dependencies
- **@neondatabase/serverless**: PostgreSQL database connectivity
- **drizzle-orm**: Type-safe ORM for database operations
- **express**: Web application framework
- **react**: Frontend UI library
- **@tanstack/react-query**: Server state management
- **passport**: Authentication middleware

### UI Dependencies
- **@radix-ui/***: Accessible UI primitives
- **tailwindcss**: Utility-first CSS framework
- **lucide-react**: Icon library
- **wouter**: Lightweight routing

### File Processing
- **multer**: File upload handling
- **csv-parse**: CSV file parsing
- **fast-csv**: CSV file generation

### Cloud Services
- **@aws-sdk/client-s3**: AWS S3 integration for backup storage
- **node-schedule**: Automated task scheduling

## Deployment Strategy

### Environment Configuration
- **Development**: Local database with environment-specific naming (_dev suffix)
- **Production**: Direct database connection without environment suffix
- **Testing**: Isolated test database (_test suffix)

### Database Management
- **Schema Versioning**: Tracks database schema changes and migrations
- **Environment Separation**: Different database instances for each environment
- **Backup Strategy**: Automated daily backups with configurable retention
- **Fallback Storage**: In-memory storage fallback when database is unavailable

### Security Considerations
- **Authentication**: Session-based authentication with secure password hashing
- **Authorization**: Role-based access control (admin, manager, analyst roles)
- **Audit Logging**: Comprehensive logging of all user actions and system events
- **Data Validation**: Input validation using Zod schemas
- **Environment Variables**: Secure configuration management

### Performance Optimizations
- **Database Indexing**: Optimized queries with appropriate indexes
- **Caching**: React Query provides intelligent caching of server data
- **File Processing**: Async processing of large CSV files
- **Pagination**: Efficient data loading with pagination support

The system is designed to be deployed on Replit with PostgreSQL via Neon.tech, providing a scalable and maintainable solution for merchant management operations.